name: Release

permissions:
  id-token: write
  contents: write

on:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/release.yml"
      - "awesome/**"
  workflow_dispatch:

jobs:
  render-data:
    name: Render Data
    runs-on: ubuntu-22.04
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Setup
        run: |
          make setup-ci
          make release ARGS=--without-analytics

      - name: Render awesome README.md
        run: |
          git config --global user.email "${{ secrets.ACTION_EMAIL }}"
          git config --global user.name "FabrizioCafolla"
          if [ -z "$(git status --porcelain)" ]; then
              echo "Nothing to update"
          else
              git add awesome/**/README.md
              git add analytics/*
              git commit -m "release(awesome): update awesome data"
              git push
          fi

      - name: Trigger deployment workflow
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.ACTION_WORKFLOWS }}
          retries: 3
          script: |
            const owner = 'italia-opensource';
            const repo = 'italia-opensource-website';
            const event_type = 'deployment';
            const ref = 'main';

            github.rest.repos.createDispatchEvent({
                owner,
                repo,
                event_type
            });
